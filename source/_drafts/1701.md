---
title: 渗透学习笔记 - 二、初识sql注入
id: 1701
categories:
  - 安全
date: 2014-12-09 16:10:54
tags:
---

首先安利一本书，[sql注入攻击与防御（第二版）](http://book.douban.com/subject/25815527/)。

因为我这个教程很薄，只有那么几页，肯定没有书上讲得深入。如果要深入了解，去看书；如果要入门得快一些，来看我的教程。

还有，看这章之前，最好知道几个基本的sql语句怎么写，以及了解一种编程语言，知道它是怎么访问数据库的。

<!--more-->

## 原因

sql注入产生原因是，程序没有对输入数据进行过滤、转义，访问数据库的时候也没有预编译。它违背了**数据与代码分离**的原则。

举个例子，比如某个显示文章的页面是这样的：

    http://www.xxx.com/yyy.php?id=1234`</pre>

    那么它里面的代码，拼装sql查询字符串的逻辑可能是这样的：

    <pre>`$sql = &#39;SELECT * FROM article WHERE id=&#39; . $_GET[&#39;id&#39;];`</pre>

    这条语句执行后`$sql`值为：

    <pre>`SELECT * FROM article WHERE id=1234`</pre>

    如果我们在url最后加上`%20and%201=1`，其中`%20`是空格的url编码格式，会变成：

    <pre>`SELECT * FROM article WHERE id=1234 and 1=1

这时候这个语句就整个变了，而不是id的参数发生变化。如果我们在后面添加任意别的东西，只要符合sql的语法，就可以让它执行任何我们想要的东西。

然后对几个概念进行一下解释。

**过滤**

就是如果某个输入数据具有格式，一般用正则表达式对其格式进行验证。比如说上面的id应该是纯数字的，可以用`\d+`进行验证。

**转义**

如果输入数据可以是任意字符，那么按照sql语言的规范对其进行转义。主要有四个字符需要转义，`\0`转成`\\0`，`&#39;`转成`\&#39;`，`\`转成`\\`，`&quot;`转成`\&quot;`。这样的话，这些字符就会完全被视为数据，而不是sql结构的一部分。

**预编译**

数据库提供的一种高级机制，具体操作方法是生成sql时先用问号代替输入参数，之后再进行绑定。由于绑定参数之前就编译了sql语句，所以输入数据无论什么样子都只会视为数据。如果你用的库是预编译的，则不需要转义。

由于早期网页程序员基本都是从美工转过来的，**防御性编程**意识淡薄，再加上那时候搞渗透的人少，往往都不会对输入数据检验。早期的各种数据库貌似还不支持预编译，于是就有一堆有漏洞的程序。

## 啊D注入工具

再给大家安利一个工具，啊D注入工具。它是windows平台下面最常用的sql注入检测工具。

![](http://ww4.sinaimg.cn/mw690/841aea59gw1en3gb9ma8fj20kf0g777f.jpg)

请直接到作者官网下载。打开工具之后，首先看到的是上图的界面。首先在(1)处填写完整的url，之后点击旁边(2)处的按钮。这一步是检测目标是否可以被注入。如果可以被注入，则(3)处的按钮会弹起，否则会弹出消息框，提示不能注入，这样的话就只能换个页面了。

之后，点击(3)处的按钮，工具会自动检测表段，即数据库中有哪些表。检测的结果会列在下面的列表框中。当然，也可能一个结果都没有，因为数据库中的表都避开了所有常见的名字。这种情况也是无法继续的。

之后点击(3)下面任意一个表名称，会发现(4)处的按钮弹起，这时候可以点击它来测试所选表的字段了。结果会显示在(4)下面的列表框中，同样，也有可能没有任何结果。

再选中任意一个字段，点击(5)处的按钮，工具会把这个字段的内容获取出来。

## 手工注入

如果你找了一个站点，跟着上面的步骤做了一次注入检测，而且恰好有注入点的话，会发现工具底部的状态栏时不时显示sql语句。这些都是工具执行的整个过程，我们也可以通过手动注入来一探究竟。

首先说一下如何找注入点，在任意搜索引擎上搜索`inurl:asp?id=`，结果中显示的url会带有`asp?id=`字符。之后就是一个一个找了，也可以用工具批量检测。

这篇教程中，我们的目标是`http://www.lygdog.com/showinfo2.asp?id=876`。由于现在这种注入点不好找了，使用了以前的一个教程，这个url现在已经不能注入了。

**step1**

判断是否可以被注入。在网址后面加上`%20and%201=1`和`%20and%201=2`。如果前者显示的页面和没加一样，并且后者显示的页面样式一样、内容没有，则说明可以注入。

这是什么意思呢，放两张图就知道了。

![](http://img3.douban.com/view/note/large/public/p192961041-3.jpg)

![](http://img3.douban.com/view/note/large/public/p192961041-4.jpg)

可以看出，第二张图的banner和导航还是有的，只是内容的地方变为“数据库出错”。

如果1=1这种情况出错了，则说明目标站点采取了拦截式的过滤方式。如果1=2这种情况仍然正常，则说明目标站点采取了筛选式的过滤方式（即把异常字符全部丢掉）。这两种情况都是不可注入的。

**step2**

猜测表名称。末尾加上`%20and%20exists%20(select%20*%20from%20[表名])`。常见表名就那么几种，可以参考啊D里面的列表。如果页面显示正常则说明表名存在，反之不存在。

![](http://img5.douban.com/view/note/large/public/p192961041-7.jpg)

这个网站的结果是`admin`存在。

**step3**

猜测字段名称。末尾加上`%20and%20exists%20(select%20[字段名]%20from%20admin)`。和上面同理。

![](http://img5.douban.com/view/note/large/public/p192961041-8.jpg)

结果是存在`username`和`password`。

**step4**

猜当前结果的最大字段数。简述一下原理，一个页面要显示文章，肯定要访问`article`表，但是我们要的数据在`admin`表。要想让他显示出来，就必须union结果，union的前提是两个结果字段数相同。所以我们要知道`select xxx from article`的字段数。

url末尾加上`%20order%20by%20[N]`，其中N是数字，从1开始一直往上增加。如果测试到k时正常显示，k+1时不显示，则最大字段数为k。

这个页面的结果为28。程序里面肯定是`select *`的。

**step5**

构造相等字段数的结果。我们不知道程序到底使用了哪些列，有些程序员做查询的时候，喜欢直接`select *`一起抓出来，但是这些列又不是每个都使用。就像这个例子，28个列肯定不可能都使用到。

url末尾加上`%20union%20select%201,2,3,...,[N]%20from%20admin`，N是上一步的结果。也就是说，从1写到N，有多少个就写多少个。由于union之后，我们构造的东西会在结果集前面的位置，程序会优先显示我们的东西。

![](http://img3.douban.com/view/note/large/public/p192961041-12.jpg)

结果如图，第7和21列是被显示的列。

**step6**

把7和21换成`username`和`password`，结果如图：

![](http://img3.douban.com/view/note/large/public/p192961041-14.jpg)

密码是md5加密之后的，放进cmd5解密即可。

## 注

手工注入教程的目标站点和图片来自[<a href="http://www.douban.com/note/192961041/">http://www.douban.com/note/192961041/](http://www.douban.com/note/192961041/)</a>。